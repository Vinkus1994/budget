<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Budget ‚Äî App perso</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#334155">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Budget">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">

  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --ink:#111827; --muted:#6b7280; --line:#e5e7eb;
      --pri:#334155; --pri2:#e2e8f0; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
      --shadow: 0 10px 30px rgba(17,24,39,.06); --r:18px;
      --grid-gap: 14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(900px 500px at 15% 0%, #eef2ff 0%, var(--bg) 60%), var(--bg);
      color:var(--ink);
      -webkit-font-smoothing: antialiased;
      -webkit-text-size-adjust: 100%;
    }

    /* ‚úÖ Safe area iPhone + padding mobile */
    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:
        calc(12px + env(safe-area-inset-top))
        calc(12px + env(safe-area-inset-right))
        calc(18px + env(safe-area-inset-bottom))
        calc(12px + env(safe-area-inset-left));
    }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:6px 0 12px;
      flex-wrap:wrap;
    }
    .brand{display:flex;align-items:center;gap:10px;min-width:220px}
    .logo{width:42px;height:42px;border-radius:14px;background:linear-gradient(135deg,var(--pri),#64748b);box-shadow:var(--shadow);flex:0 0 auto}
    h1{font-size:20px;margin:0}
    .sub{font-size:13px;color:var(--muted);margin-top:2px}

    .top-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      flex:1 1 auto;
    }

    button{
      border:0;border-radius:14px;
      padding:10px 12px;
      background:var(--pri);color:#fff;cursor:pointer;
      box-shadow:var(--shadow);
      font-weight:700;
    }
    button.ghost{background:var(--card);color:var(--ink);border:1px solid var(--line);box-shadow:none}
    button.danger{background:#991b1b}
    button.alt{background:#475569}

    .btn-sm{
      padding:9px 10px;
      font-size:12px;
      border-radius:12px;
      box-shadow:none;
      white-space:nowrap;
    }

    /* Desktop grid */
    .grid{
      display:grid;
      grid-template-columns:1.2fr .8fr;
      gap: var(--grid-gap);
      align-items:start;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card-h b{font-size:14px}
    .card-b{padding:16px}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .kpi{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .k{
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      background:#fbfbfc;
    }
    .k .t{font-size:12px;color:var(--muted)}
    .k .v{font-size:24px;font-weight:900;margin-top:6px;letter-spacing:-.02em}
    .k .s{font-size:12px;color:var(--muted);margin-top:4px}
    .span2{grid-column:1/-1}

    .bar{height:10px;border-radius:999px;background:#e5e7eb;overflow:hidden;margin-top:10px}
    .fill{height:100%;width:0%;background:linear-gradient(90deg,#334155,#64748b);border-radius:999px;transition:width .25s ease}
    .barline{display:flex;justify-content:space-between;gap:10px;font-size:12px;color:var(--muted);margin-top:8px}

    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:var(--pri2);color:#0f172a;font-size:12px;font-weight:800}
    .dot{width:10px;height:10px;border-radius:99px;background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}

    form{display:grid;gap:10px}
    label{font-size:12px;color:var(--muted)}
    input,select{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      outline:none;
      font-size:14px;
    }
    input:focus,select:focus{border-color:#cbd5e1;box-shadow:0 0 0 4px rgba(100,116,139,.12)}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}

    .actions4{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:8px;
      align-items:stretch;
    }

    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background:#fff;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
    }
    .item .left{display:flex;flex-direction:column;gap:4px;min-width:0}
    .item .cat{font-weight:900}
    .item .meta{font-size:12px;color:var(--muted)}
    .item .amt{font-weight:900}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;
      font-size:11px;font-weight:800;color:#0f172a;width:fit-content
    }
    .x{border:1px solid var(--line);background:#fff;color:#111827;border-radius:12px;padding:8px 10px;cursor:pointer}
    .hint{font-size:12px;color:var(--muted);line-height:1.35}
    .hide{display:none!important}
    .sep{height:1px;background:var(--line);margin:10px 0}

    .toast{
      position:fixed;
      left:50%;
      bottom:calc(14px + env(safe-area-inset-bottom));
      transform:translateX(-50%);
      background:#111827;color:#fff;
      padding:10px 12px;border-radius:14px;
      opacity:0;pointer-events:none;
      transition:.25s;
      box-shadow:var(--shadow);
      font-size:13px;
      z-index:50
    }
    .toast.show{opacity:1}

    .overlay{position:fixed;inset:0;background:rgba(15,23,42,.45);display:flex;align-items:center;justify-content:center;padding:18px;z-index:100}
    .welcome{width:min(560px,100%);background:var(--card);border:1px solid var(--line);border-radius:22px;box-shadow:0 30px 80px rgba(0,0,0,.18);overflow:hidden}
    .welcome-h{padding:16px 18px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .welcome-h b{font-size:15px}
    .welcome-b{padding:18px}

    /* ‚úÖ MOBILE FIRST: layout iPhone propre */
    @media (max-width: 859px){
      header{flex-direction:column;align-items:stretch}
      .top-actions{justify-content:stretch}
      .top-actions button{flex:1}

      .grid{grid-template-columns:1fr;gap:12px}

      .card-h{padding:12px 14px}
      .card-b{padding:14px}

      .kpi{grid-template-columns:1fr}     /* ‚úÖ KPI en 1 colonne */
      .two{grid-template-columns:1fr}     /* ‚úÖ Formulaires en 1 colonne */

      /* ‚úÖ Boutons en colonne (ta demande) */
      .actions4{grid-template-columns:1fr}

      #setupCard{width:100%;}

      /* Swipe wrapper */
      .grid.swipe-mobile{display:block}
      .mobileTabs{display:flex;gap:8px;margin:0 0 10px}
      .mobileTabs button{flex:1;border-radius:14px}

      .swipeWrap{position:relative;overflow:hidden;border-radius:0}
      .swipeTrack{
        display:flex;
        width:200%;
        touch-action: pan-y;
        transition: transform .25s ease;
        will-change: transform;
      }
      .swipePage{width:49%;flex:0 0 49%}
      .swipeTrack.dragging{transition:none}
    }

    /* Desktop: on garde la grille normale */
    @media (min-width: 860px){
      .mobileTabs{display:none}
      .swipeWrap{display:contents}
      .swipeTrack{display:contents;width:auto;transform:none !important}
      .swipePage{width:auto;flex:auto}

      /* ‚úÖ R√©glages = m√™me largeur que R√©sum√© (1.2fr sur 1.2fr+.8fr = 60%) */
      #setupCard{width: calc((100% - var(--grid-gap)) * 0.6); margin-right:auto;}
    }

    /* Cache l‚ÄôUI swipe quand l‚Äôhistorique est vide */
    .mobileTabs.disabled { display:none !important; }
  </style>
</head>

<body>
  <!-- Page 1 : soldes actuels -->
  <div class="overlay hide" id="welcomeOverlay">
    <div class="welcome">
      <div class="welcome-h">
        <b>Bienvenue üëã ‚Äî Soldes actuels</b>
        <span class="pill"><span class="dot"></span>D√©but</span>
      </div>
      <div class="welcome-b">
        <div class="hint">Mets ce que tu as <b>maintenant</b> sur ton compte √† vue et ton compte √©pargne.</div>
        <div style="height:12px"></div>
        <form id="welcomeForm">
          <div class="two">
            <div>
              <label>Compte √† vue ‚Äî solde actuel (‚Ç¨)</label>
              <input id="initChecking" inputmode="decimal" placeholder="ex: 650" required />
            </div>
            <div>
              <label>Compte √©pargne ‚Äî solde actuel (‚Ç¨)</label>
              <input id="initSavings" inputmode="decimal" placeholder="ex: 1200" required />
            </div>
          </div>
          <div class="hint">Ensuite, tu peux r√©gler l‚Äôobjectif d‚Äô√©pargne dans ‚ÄúR√©glages‚Äù.</div>
          <button type="submit">Continuer</button>
        </form>
      </div>
    </div>
  </div>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Budget</h1>
          <div class="sub">Simple ‚Ä¢ neutre ‚Ä¢ usage perso</div>
        </div>
      </div>
      <div class="top-actions">
        <button class="ghost" id="btnSetup">R√©glages</button>
        <button class="ghost" id="btnExport">Exporter</button>
        <button class="danger" id="btnReset">Reset</button>
      </div>
    </header>

    <div class="grid swipe-mobile" id="gridMain">
      <div class="mobileTabs" id="mobileTabs">
        <button class="ghost" type="button" id="tabResume">R√©sum√©</button>
        <button class="ghost" type="button" id="tabHistory">Historique</button>
      </div>

      <div class="swipeWrap" id="swipeWrap">
        <div class="swipeTrack" id="swipeTrack">

          <!-- PAGE 1 -->
          <div class="swipePage">
            <section class="card">
              <div class="card-h">
                <b>R√©sum√©</b>
                <span class="pill"><span class="dot" id="dotState"></span><span id="stateTxt">OK</span></span>
              </div>
              <div class="card-b">
                <div class="row" style="justify-content:space-between;align-items:center">
                  <div class="hint" id="periodTxt">P√©riode‚Ä¶</div>
                  <div class="hint" id="infoTxt">Objectif‚Ä¶</div>
                </div>

                <div class="sep"></div>

                <div class="kpi">
                  <div class="k">
                    <div class="t">Compte √† vue (solde r√©el)</div>
                    <div class="v" id="kCheckingReal">‚Äî</div>
                    <div class="s" id="kCheckingRealSub">‚Äî</div>
                  </div>

                  <div class="k">
                    <div class="t">Compte √©pargne (solde r√©el)</div>
                    <div class="v" id="kSavingsReal">‚Äî</div>
                    <div class="s" id="kSavingsRealSub">‚Äî</div>
                  </div>

                  <div class="k span2">
                    <div class="t">D√©penses</div>
                    <div class="v" id="kSpendMonth">‚Äî</div>
                    <div class="s" id="kSpendSub">Sur 12 mois: ‚Äî</div>
                  </div>
                </div>

                <div class="sep"></div>
                <b style="font-size:14px">√âpargne</b>
                <div class="hint">Progression = transferts vers √©pargne (moins retraits) vs objectif.</div>
                <div style="height:10px"></div>

                <div class="two">
                  <div class="k">
                    <div class="t">√âpargne du mois</div>
                    <div class="v" id="kSaveMonth">‚Äî</div>
                    <div class="s" id="kSaveMonthSub">Objectif: ‚Äî</div>
                    <div class="bar"><div class="fill" id="barMonth"></div></div>
                    <div class="barline"><span id="pctMonth">0%</span><span id="restMonth">Reste: ‚Äî</span></div>
                  </div>

                  <div class="k">
                    <div class="t">√âpargne (12 mois glissants)</div>
                    <div class="v" id="kSave12">‚Äî</div>
                    <div class="s" id="kSave12Sub">Objectif estim√©: ‚Äî</div>
                    <div class="bar"><div class="fill" id="bar12"></div></div>
                    <div class="barline"><span id="pct12">0%</span><span id="rest12">Reste: ‚Äî</span></div>
                  </div>
                </div>

                <div class="sep"></div>
                <b style="font-size:14px">Ajouter / Mouvement</b>
                <div class="hint">Salaire variable : ajoute-le via <b>Entr√©e √† vue</b> et cat√©gorie <b>Salaire</b>.</div>
                <div style="height:10px"></div>

                <form id="moveForm">
                  <div class="two">
                    <div>
                      <label>Montant (‚Ç¨)</label>
                      <input id="amount" inputmode="decimal" placeholder="ex: 12,50" required />
                    </div>
                    <div>
                      <label>Cat√©gorie</label>
                      <select id="category">
                        <optgroup label="Entr√©es">
                          <option value="Salaire">Salaire</option>
                          <option value="Remboursement">Remboursement</option>
                          <option value="Cadeau">Cadeau</option>
                          <option value="Vente">Vente</option>
                          <option value="Autre (entr√©e)">Autre (entr√©e)</option>
                        </optgroup>
                        <optgroup label="D√©penses">
                          <option value="Nourriture">Nourriture</option>
                          <option value="Logement">Logement</option>
                          <option value="Transport">Transport</option>
                          <option value="Loisirs">Loisirs</option>
                          <option value="Shopping">Shopping</option>
                          <option value="Factures">Factures</option>
                          <option value="Autres">Autres</option>
                        </optgroup>
                      </select>
                    </div>
                  </div>

                  <div>
                    <label>Note (optionnel)</label>
                    <input id="note" placeholder="ex: mutuelle / ticket / resto" />
                  </div>

                  <div class="actions4">
                    <button type="button" class="alt btn-sm" id="btnCredit">Entr√©e √† vue</button>
                    <button type="button" class="alt btn-sm" id="btnToSavings">Vers √©pargne</button>
                    <button type="button" class="alt btn-sm" id="btnFromSavings">Depuis √©pargne</button>
                    <button type="submit" class="btn-sm">D√©pense</button>
                  </div>
                </form>
              </div>
            </section>
          </div>

          <!-- PAGE 2 -->
          <div class="swipePage">
            <section class="card">
              <div class="card-h">
                <b>Historique</b>
                <span class="hint" id="countTxt">0 mouvement</span>
              </div>
              <div class="card-b">
                <div class="list" id="list"></div>
                <div class="hint" id="emptyTxt">Aucun mouvement pour cette p√©riode.</div>
              </div>
            </section>
          </div>

        </div>
      </div>
    </div>

    <!-- R√©glages -->
    <section class="card" id="setupCard" style="margin-top:14px">
      <div class="card-h">
        <b>R√©glages</b>
        <button class="ghost" id="btnCloseSetup">Fermer</button>
      </div>
      <div class="card-b">
        <form id="setupForm">
          <div class="two">
            <div>
              <label>Objectif √©pargne du mois (‚Ç¨)</label>
              <input id="savingsGoal" inputmode="decimal" placeholder="ex: 150" value="0" />
            </div>
            <div>
              <label>Jour de d√©but du mois (budget)</label>
              <select id="startDay"></select>
            </div>
          </div>

          <div class="two">
            <div>
              <label>Solde initial compte √† vue (‚Ç¨)</label>
              <input id="checkingBalance" inputmode="decimal" placeholder="ex: 650" value="0" />
            </div>
            <div>
              <label>Solde initial compte √©pargne (‚Ç¨)</label>
              <input id="savingsBalance" inputmode="decimal" placeholder="ex: 1200" value="0" />
            </div>
          </div>

          <button type="submit">Enregistrer</button>
        </form>
      </div>
    </section>
  </div>

  <div class="toast" id="toast">OK</div>

  <script>
    // PWA SW
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").catch(()=>{});
      });
    }

    const KEY_SETTINGS = "bb_settings_v18";
    const KEY_MOVES = "bb_moves_v18";
    const $ = (id) => document.getElementById(id);
    const state = { settings: null, moves: [] };

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 1400);
    }

    function parseMoney(str){
      if(!str && str !== 0) return NaN;
      const s = String(str).replace(/\s/g,'').replace(',', '.');
      const n = Number(s);
      return Number.isFinite(n) ? n : NaN;
    }

    function fmtEUR(v){
      return new Intl.NumberFormat('fr-BE', { style:'currency', currency:'EUR' }).format(v);
    }

    function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

    function load(){
      try{ const s = localStorage.getItem(KEY_SETTINGS); state.settings = s ? JSON.parse(s) : null; }catch{ state.settings = null; }
      try{ const e = localStorage.getItem(KEY_MOVES); state.moves = e ? JSON.parse(e) : []; }catch{ state.moves = []; }
    }

    function save(){
      localStorage.setItem(KEY_SETTINGS, JSON.stringify(state.settings));
      localStorage.setItem(KEY_MOVES, JSON.stringify(state.moves));
    }

    function budgetPeriod(startDay, now=new Date()){
      const y=now.getFullYear(), m=now.getMonth();
      const startThis = new Date(y, m, startDay);
      const start = (now < startThis) ? new Date(y, m-1, startDay) : startThis;
      const endExclusive = new Date(start.getFullYear(), start.getMonth()+1, startDay);
      return { start, endExclusive };
    }

    function rolling12Period(now=new Date()){
      const endExclusive = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1);
      const start = new Date(now); start.setMonth(start.getMonth()-12);
      return { start, endExclusive };
    }

    function sameOrAfter(a,b){ return a.getTime() >= b.getTime(); }
    function before(a,b){ return a.getTime() < b.getTime(); }

    function inPeriod(dateISO, p){
      const d = new Date(dateISO);
      return sameOrAfter(d, p.start) && before(d, p.endExclusive);
    }

    function daysRemaining(p){
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      return Math.floor((p.endExclusive.getTime() - today.getTime()) / (1000*60*60*24));
    }

    function niceDate(d){ return d.toLocaleDateString('fr-BE', { weekday:'short', day:'numeric', month:'short' }); }
    function niceDateTime(iso){
      const d = new Date(iso);
      return d.toLocaleString('fr-BE', { weekday:'short', day:'numeric', month:'short', hour:'2-digit', minute:'2-digit' });
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    function setStatePill(perDay){
      const dot = $("dotState");
      const txt = $("stateTxt");
      dot.className = "dot";
      if(perDay >= 15){ txt.textContent = "OK"; }
      else if(perDay >= 5){ dot.classList.add("warn"); txt.textContent = "Attention"; }
      else { dot.classList.add("bad"); txt.textContent = "Danger"; }
    }

    function compute(period){
      const periodMoves = state.moves
        .filter(m => inPeriod(m.date, period))
        .sort((a,b)=> new Date(b.date) - new Date(a.date));

      const credit = periodMoves.filter(m => m.type === "credit").reduce((s,m)=> s + m.amount, 0);
      const spent  = periodMoves.filter(m => m.type === "expense").reduce((s,m)=> s + m.amount, 0);
      const toSavings   = periodMoves.filter(m => m.type === "toSavings").reduce((s,m)=> s + m.amount, 0);
      const fromSavings = periodMoves.filter(m => m.type === "fromSavings").reduce((s,m)=> s + m.amount, 0);

      return { periodMoves, credit, spent, toSavings, fromSavings };
    }

    function computeAll(){
      const creditAll = state.moves.filter(m => m.type === "credit").reduce((s,m)=> s + m.amount, 0);
      const spentAll  = state.moves.filter(m => m.type === "expense").reduce((s,m)=> s + m.amount, 0);
      const toSavingsAll   = state.moves.filter(m => m.type === "toSavings").reduce((s,m)=> s + m.amount, 0);
      const fromSavingsAll = state.moves.filter(m => m.type === "fromSavings").reduce((s,m)=> s + m.amount, 0);
      return { creditAll, spentAll, toSavingsAll, fromSavingsAll };
    }

    function addCreditNow(){
      if(!state.settings) return toast("Configure d‚Äôabord les soldes");
      const amount = parseMoney($("amount").value);
      const category = $("category").value;
      const note = $("note").value.trim();
      if(!Number.isFinite(amount) || amount <= 0) return toast("Montant invalide");

      state.moves.unshift({
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
        type: "credit",
        amount,
        category,
        note: note || null,
        date: new Date().toISOString()
      });

      save();
      $("amount").value = "";
      $("note").value = "";
      $("amount").focus();
      render();
      toast("Entr√©e ajout√©e");
    }

    function addMove(type){
      if(!state.settings) return toast("Configure d‚Äôabord les soldes");
      const amount = parseMoney($("amount").value);
      const category = $("category").value;
      const note = $("note").value.trim();
      if(!Number.isFinite(amount) || amount <= 0) return toast("Montant invalide");

      if(type === "fromSavings"){
        const all = computeAll();
        const savingsNow = (state.settings.savingsBalance ?? 0) + all.toSavingsAll - all.fromSavingsAll;
        if(amount > savingsNow) return toast("Pas assez sur l‚Äô√©pargne");
      }

      state.moves.unshift({
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
        type,
        amount,
        category: type === "expense" ? category : (type === "toSavings" ? "Vers √©pargne" : "Depuis √©pargne"),
        note: note || null,
        date: new Date().toISOString()
      });

      save();
      $("amount").value = "";
      $("note").value = "";
      $("amount").focus();
      render();
    }

    function ensureWelcome(){
      const ov = $("welcomeOverlay");
      if(!state.settings || typeof state.settings.checkingBalance !== "number" || typeof state.settings.savingsBalance !== "number"){
        ov.classList.remove("hide");
      }else{
        ov.classList.add("hide");
      }
    }

    function render(){
      ensureWelcome();

      const setupCard = $("setupCard");
      setupCard.classList.toggle("hide", !!state.settings && !setupCard.dataset.forceOpen);

      if(!state.settings){
        $("periodTxt").textContent = "Configure d‚Äôabord tes soldes (√©cran de d√©part).";
        $("infoTxt").textContent = "";
        $("kCheckingReal").textContent = "‚Äî";
        $("kCheckingRealSub").textContent = "‚Äî";
        $("kSavingsReal").textContent = "‚Äî";
        $("kSavingsRealSub").textContent = "‚Äî";
        $("kSpendMonth").textContent = "‚Äî";
        $("kSpendSub").textContent = "Sur 12 mois: ‚Äî";
        $("kSaveMonth").textContent = "‚Äî";
        $("kSaveMonthSub").textContent = "Objectif: ‚Äî";
        $("barMonth").style.width = "0%";
        $("pctMonth").textContent = "0%";
        $("restMonth").textContent = "Reste: ‚Äî";
        $("kSave12").textContent = "‚Äî";
        $("kSave12Sub").textContent = "Objectif estim√©: ‚Äî";
        $("bar12").style.width = "0%";
        $("pct12").textContent = "0%";
        $("rest12").textContent = "Reste: ‚Äî";
        $("list").innerHTML = "";
        $("emptyTxt").classList.remove("hide");
        $("countTxt").textContent = "0 mouvement";
        setStatePill(999);

        // üîí pas d'historique => swipe OFF
        if (window.__setHistoryEnabled) window.__setHistoryEnabled(false);
        return;
      }

      const s = state.settings;
      const startDay = Number(s.monthStartDay ?? 1);
      const period = budgetPeriod(startDay, new Date());
      $("periodTxt").textContent = `P√©riode: ${niceDate(period.start)} ‚Üí ${niceDate(new Date(period.endExclusive.getTime()-86400000))}`;

      const savingsGoal = Number(s.savingsGoal ?? 0);
      $("infoTxt").textContent = `Objectif √©pargne: ${fmtEUR(savingsGoal)}`;

      const all = computeAll();
      const checkingBase = Number(s.checkingBalance ?? 0);
      const savingsBase  = Number(s.savingsBalance ?? 0);

      const checkingReal = checkingBase + all.creditAll - all.spentAll - all.toSavingsAll + all.fromSavingsAll;
      const savingsReal  = savingsBase + all.toSavingsAll - all.fromSavingsAll;

      const { periodMoves, credit, spent, toSavings, fromSavings } = compute(period);

      // ‚úÖ Swipe UNIQUEMENT s'il y a un historique sur la p√©riode
      if (window.__setHistoryEnabled) window.__setHistoryEnabled(periodMoves.length > 0);

      const remaining = (credit - spent - toSavings + fromSavings);

      const dLeft = daysRemaining(period);
      const safeDays = dLeft <= 0 ? 1 : dLeft;
      setStatePill(remaining / safeDays);

      $("kCheckingReal").textContent = fmtEUR(checkingReal);
      $("kCheckingRealSub").textContent = `Reste p√©riode: ${fmtEUR(remaining)}`;

      $("kSavingsReal").textContent = `${fmtEUR(savingsReal)} (${fmtEUR(savingsGoal)})`;
      $("kSavingsRealSub").textContent = `Objectif mensuel: ${fmtEUR(savingsGoal)}`;

      const r12 = rolling12Period(new Date());
      const r = compute(r12);
      $("kSpendMonth").textContent = `${fmtEUR(spent)} (mois)`;
      $("kSpendSub").textContent = `Sur 12 mois: ${fmtEUR(r.spent)}`;

      const savedMonth = toSavings - fromSavings;
      const monthGoal = Math.max(0, savingsGoal);
      const monthPct = monthGoal > 0 ? clamp((savedMonth / monthGoal) * 100, 0, 100) : 0;

      $("kSaveMonth").textContent = fmtEUR(savedMonth);
      $("kSaveMonthSub").textContent = `Objectif: ${fmtEUR(monthGoal)}`;
      $("barMonth").style.width = `${monthPct}%`;
      $("pctMonth").textContent = `${Math.round(monthPct)}%`;
      $("restMonth").textContent = `Reste: ${fmtEUR(Math.max(0, monthGoal - savedMonth))}`;

      const saved12 = r.toSavings - r.fromSavings;
      const goal12 = Math.max(0, monthGoal * 12);
      const pct12 = goal12 > 0 ? clamp((saved12 / goal12) * 100, 0, 100) : 0;

      $("kSave12").textContent = fmtEUR(saved12);
      $("kSave12Sub").textContent = `Objectif estim√©: ${fmtEUR(goal12)}`;
      $("bar12").style.width = `${pct12}%`;
      $("pct12").textContent = `${Math.round(pct12)}%`;
      $("rest12").textContent = `Reste: ${fmtEUR(Math.max(0, goal12 - saved12))}`;

      const list = $("list");
      list.innerHTML = "";
      $("countTxt").textContent = `${periodMoves.length} mouvement${periodMoves.length>1?'s':''}`;

      if(periodMoves.length === 0){
        $("emptyTxt").classList.remove("hide");
      }else{
        $("emptyTxt").classList.add("hide");
        periodMoves.forEach(m => {
          let tag = "", title = "";
          if(m.type === "credit"){ tag="Entr√©e"; title = `${escapeHtml(m.category)} ‚Ä¢ <span class="amt">${fmtEUR(m.amount)}</span>`; }
          if(m.type === "expense"){ tag="D√©pense"; title = `${escapeHtml(m.category)} ‚Ä¢ <span class="amt">${fmtEUR(m.amount)}</span>`; }
          if(m.type === "toSavings"){ tag="Transfert"; title = `Vers √©pargne ‚Ä¢ <span class="amt">${fmtEUR(m.amount)}</span>`; }
          if(m.type === "fromSavings"){ tag="Retrait"; title = `Depuis √©pargne ‚Ä¢ <span class="amt">${fmtEUR(m.amount)}</span>`; }

          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = `
            <div class="left">
              <div class="tag">${tag}</div>
              <div class="cat">${title}</div>
              <div class="meta">${niceDateTime(m.date)}${m.note ? " ‚Äî " + escapeHtml(m.note) : ""}</div>
            </div>
            <button class="x" title="Supprimer">‚úï</button>
          `;
          div.querySelector("button").addEventListener("click", () => {
            state.moves = state.moves.filter(x => x.id !== m.id);
            save(); render(); toast("Supprim√©");
          });
          list.appendChild(div);
        });
      }
    }

    function fillStartDays(){
      const sel = $("startDay");
      sel.innerHTML = "";
      for(let i=1;i<=28;i++){
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = i;
        sel.appendChild(opt);
      }
    }

    $("welcomeForm").addEventListener("submit",(ev)=>{
      ev.preventDefault();
      const chk = parseMoney($("initChecking").value);
      const sav = parseMoney($("initSavings").value);
      if(!Number.isFinite(chk) || chk < 0) return toast("Solde compte √† vue invalide");
      if(!Number.isFinite(sav) || sav < 0) return toast("Solde √©pargne invalide");

      state.settings = {
        savingsGoal: state.settings?.savingsGoal ?? 0,
        monthStartDay: state.settings?.monthStartDay ?? 1,
        checkingBalance: chk,
        savingsBalance: sav
      };
      save();
      $("welcomeOverlay").classList.add("hide");
      $("checkingBalance").value = chk;
      $("savingsBalance").value = sav;
      $("setupCard").dataset.forceOpen = "1";
      $("setupCard").classList.remove("hide");
      render();
    });

    $("setupForm").addEventListener("submit",(ev)=>{
      ev.preventDefault();
      const goal = parseMoney($("savingsGoal").value) || 0;
      const startDay = Number($("startDay").value || 1);
      const checkingBase = parseMoney($("checkingBalance").value) || 0;
      const savingsBase = parseMoney($("savingsBalance").value) || 0;
      if(goal < 0 || checkingBase < 0 || savingsBase < 0) return toast("Valeur invalide");

      state.settings = { savingsGoal: goal, monthStartDay: startDay, checkingBalance: checkingBase, savingsBalance: savingsBase };
      save();
      $("setupCard").dataset.forceOpen = "";
      $("setupCard").classList.add("hide");
      render();
    });

    $("btnCredit").addEventListener("click", addCreditNow);
    $("btnToSavings").addEventListener("click", ()=> addMove("toSavings"));
    $("btnFromSavings").addEventListener("click", ()=> addMove("fromSavings"));
    $("moveForm").addEventListener("submit",(ev)=>{ ev.preventDefault(); addMove("expense"); });

    $("btnSetup").addEventListener("click", ()=>{
      const card = $("setupCard");
      card.dataset.forceOpen = "1";
      card.classList.remove("hide");
      if(state.settings){
        $("savingsGoal").value = state.settings.savingsGoal ?? 0;
        $("checkingBalance").value = state.settings.checkingBalance ?? 0;
        $("savingsBalance").value = state.settings.savingsBalance ?? 0;
        $("startDay").value = state.settings.monthStartDay ?? 1;
      }
    });
    $("btnCloseSetup").addEventListener("click", ()=>{
      $("setupCard").dataset.forceOpen = "";
      if(state.settings) $("setupCard").classList.add("hide");
    });
    $("btnReset").addEventListener("click", ()=>{
      if(!confirm("Tout effacer ?")) return;
      localStorage.removeItem(KEY_SETTINGS);
      localStorage.removeItem(KEY_MOVES);
      load(); render();
    });
    $("btnExport").addEventListener("click", ()=>{
      const data = { exportedAt: new Date().toISOString(), settings: state.settings, moves: state.moves };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "budget-export.json";
      a.click();
      URL.revokeObjectURL(a.href);
    });

    fillStartDays();
    load();
    if(state.settings){
      $("savingsGoal").value = state.settings.savingsGoal ?? 0;
      $("checkingBalance").value = state.settings.checkingBalance ?? 0;
      $("savingsBalance").value = state.settings.savingsBalance ?? 0;
      $("startDay").value = state.settings.monthStartDay ?? 1;
      $("setupCard").classList.add("hide");
    }else{
      $("setupCard").dataset.forceOpen = "1";
    }

    // Swipe mobile (actif UNIQUEMENT s'il y a un historique)
    (function(){
      const track = document.getElementById("swipeTrack");
      const wrap = document.getElementById("swipeWrap");
      const tabResume = document.getElementById("tabResume");
      const tabHistory = document.getElementById("tabHistory");
      const tabsWrap = document.getElementById("mobileTabs");
      if(!track || !wrap || !tabResume || !tabHistory || !tabsWrap) return;

      let index = 0;
      let startX = 0, currentX = 0, isDown = false;
      let historyEnabled = false;

      const isMobile = () => window.matchMedia("(max-width: 860px)").matches;

      function updateTabs(){
        tabsWrap.classList.toggle("disabled", !historyEnabled);
        tabResume.classList.toggle("alt", index === 0);
        tabHistory.classList.toggle("alt", index === 1);
        tabResume.classList.toggle("ghost", index !== 0);
        tabHistory.classList.toggle("ghost", index !== 1);
      }

      function go(i){
        if(!historyEnabled) i = 0;
        index = Math.max(0, Math.min(1, i));
        if(isMobile()) track.style.transform = `translateX(${-index * 100}%)`;
        updateTabs();
      }

      window.__setHistoryEnabled = function(enabled){
        historyEnabled = !!enabled;
        if(!historyEnabled) index = 0;
        go(index);
      };

      tabResume.addEventListener("click", ()=> go(0));
      tabHistory.addEventListener("click", ()=> {
        if(!historyEnabled) return;
        go(1);
      });

      wrap.addEventListener("touchstart", (e)=>{
        if(!isMobile() || !historyEnabled) return;
        isDown = true;
        track.classList.add("dragging");
        startX = e.touches[0].clientX;
        currentX = startX;
      }, {passive:true});

      wrap.addEventListener("touchmove", (e)=>{
        if(!isMobile() || !historyEnabled || !isDown) return;
        currentX = e.touches[0].clientX;
        const dx = currentX - startX;
        const w = wrap.clientWidth || 1;
        const base = -index * w;
        const pos = base + dx;
        track.style.transform = `translateX(${(pos / w) * 100}%)`;
      }, {passive:true});

      wrap.addEventListener("touchend", ()=>{
        if(!isMobile() || !historyEnabled || !isDown) return;
        isDown = false;
        track.classList.remove("dragging");
        const dx = currentX - startX;
        const threshold = (wrap.clientWidth || 1) * 0.18;
        if(dx > threshold) go(index - 1);
        else if(dx < -threshold) go(index + 1);
        else go(index);
      });

      window.addEventListener("resize", ()=> go(index));
      go(0);
    })();

    render();
  </script>
</body>
</html>
